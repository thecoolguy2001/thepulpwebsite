<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Pulp AR</title>

  <!-- Three + MindAR (image tracking build) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.131.3/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.131.3/examples/js/loaders/GLTFLoader.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.7/dist/mindar-image-three.prod.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
    #container { width:100%; height:100%; }
    .hint {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 12px; color: #fff; font: 14px/1.2 system-ui, -apple-system, sans-serif;
      background: rgba(0,0,0,.45); padding: 8px 10px; border-radius: 10px;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="start-overlay" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.92);z-index:10;">
    <div style="text-align:center;color:#fff;font:16px/1.4 -apple-system,system-ui,sans-serif;padding:24px;max-width:320px;">
      <div style="margin-bottom:12px;font-weight:600;">Enable Camera to start AR</div>
      <div style="opacity:.8;margin-bottom:16px;">Tap the button below to grant camera access.</div>
      <button id="start-ar" style="appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;">Start AR</button>
      <div id="error-msg" style="margin-top:12px;color:#ffb3b3;display:none;"></div>
    </div>
  </div>
  <div class="hint">Point camera at your Pulp cover</div>

  <script>
    (async () => {
      const container = document.querySelector("#container");
      const overlay = document.querySelector('#start-overlay');
      const startBtn = document.querySelector('#start-ar');
      const errorMsg = document.querySelector('#error-msg');

      // Helper to show errors to user
      const showError = (msg) => {
        if (errorMsg) {
          errorMsg.textContent = msg;
          errorMsg.style.display = 'block';
        }
        console.error(msg);
      };

      // Secure context check (camera requires https or localhost)
      if (!window.isSecureContext) {
        showError('This page must be served over HTTPS (or localhost) for camera access.');
      }

      let mindarThree, renderer, scene, camera, anchor;
      let stack, single;

      // Pre-create loaders & lights so they exist before start
      const loader = new THREE.GLTFLoader();

      const setupScene = () => {
        const hemi = new THREE.HemisphereLight(0xffffff, 0x444466, 1.0);
        scene.add(hemi);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(0.5, 1.0, 0.5);
        scene.add(dir);
      };

      const makeAnchor = () => {
        anchor = mindarThree.addAnchor(0);
        anchor.onTargetFound = () => { if (stack) stack.visible = true; if (single) single.visible = true; };
        anchor.onTargetLost  = () => { if (stack) stack.visible = false; if (single) single.visible = false; };
      };

      const loadStack = () => new Promise((resolve, reject) => {
        loader.load("/pulp-ar/assets/test_stack.glb", (gltf) => {
          stack = gltf.scene;
          stack.scale.set(0.18, 0.18, 0.18);
          stack.position.set(0, 0, 0.002); // offset to avoid z-fighting
          anchor.group.add(stack);
          resolve();
        }, undefined, (err) => reject(err));
      });

      const loadSingle = () => new Promise((resolve, reject) => {
        loader.load("/pulp-ar/assets/test_single.glb", (gltf) => {
          single = gltf.scene;
          single.scale.set(0.16, 0.16, 0.16);
          single.position.set(0, 0, 0.08);
          single.rotation.set(THREE.Math.degToRad(-10), 0, THREE.Math.degToRad(8));
          anchor.group.add(single);
          resolve();
        }, undefined, (err) => reject(err));
      });

      const startAR = async () => {
        try {
          // Boot MindAR only after a user gesture
          mindarThree = new window.MINDAR.IMAGE.MindARThree({
            container,
            imageTargetSrc: "/pulp-ar/assets/pulp-marker.mind",
            filterMinCF: 0.0001,
            filterBeta: 0.01
          });
          ({ renderer, scene, camera } = mindarThree);

          setupScene();
          makeAnchor();

          await mindarThree.start();

          // Load models after camera permission granted
          await loadStack();
          await loadSingle();

          const clock = new THREE.Clock();
          renderer.setAnimationLoop(() => {
            const t = clock.getElapsedTime();
            if (single) {
              single.rotation.z += 0.02;
              single.position.z = 0.08 + 0.005 * Math.sin(t * 2.0);
            }
            renderer.render(scene, camera);
          });

          // Hide overlay once running
          if (overlay) overlay.style.display = 'none';
        } catch (e) {
          console.error(e);
          // Common causes: camera blocked, no https, another app using camera
          showError('Could not access camera. Check site permissions (Settings > Camera), ensure HTTPS, and close other camera apps.');
        }
      };

      // Some browsers (esp. iOS Safari) require a user gesture to start camera
      if (startBtn) {
        startBtn.addEventListener('click', startAR, { once: true });
      } else {
        // Fallback: try to auto-start if button missing
        startAR();
      }
    })();
  </script>
</body>
</html>