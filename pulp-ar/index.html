<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Pulp AR</title>

  <!-- Three + MindAR (image tracking build) -->
  <script defer src="https://cdn.jsdelivr.net/npm/three@0.131.3/build/three.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/three@0.131.3/examples/js/loaders/GLTFLoader.js"></script>

  <script defer src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-three.prod.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
    #container { width:100%; height:100%; }
    .hint {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 12px; color: #fff; font: 14px/1.2 system-ui, -apple-system, sans-serif;
      background: rgba(0,0,0,.45); padding: 8px 10px; border-radius: 10px;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="start-overlay" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.92);z-index:10;">
    <div style="text-align:center;color:#fff;font:16px/1.4 -apple-system,system-ui,sans-serif;padding:24px;max-width:320px;">
      <div style="margin-bottom:12px;font-weight:600;">Enable Camera to start AR</div>
      <div style="opacity:.8;margin-bottom:16px;">Tap the button below to grant camera access.</div>
      <button id="start-ar" style="appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;">Start AR</button>
      <div id="error-msg" style="margin-top:12px;color:#ffb3b3;display:none;"></div>
    </div>
  </div>
  <div class="hint">Point camera at your Pulp cover</div>

  <script>
    (async () => {
      // Wait until DOM is ready
      if (document.readyState !== 'complete' && document.readyState !== 'interactive') {
        await new Promise((r) => document.addEventListener('DOMContentLoaded', r, { once: true }));
      }
      // Ensure deferred library scripts have executed
      await new Promise((r) => window.requestAnimationFrame(r));

      window.addEventListener('error', (e) => {
        if (errorMsg) {
          errorMsg.textContent = 'Runtime error: ' + (e && e.message ? e.message : 'Unknown');
          errorMsg.style.display = 'block';
        }
      });

      const loadScript = (src) => new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error('Failed to load ' + src));
        document.head.appendChild(s);
      });

      const ensureMindAR = async () => {
        // If mindar already present, done
        if (window.MINDAR && window.MINDAR.IMAGE) return;
        // Try loading the official CDN path explicitly
        await loadScript('https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-three.prod.js');
        if (!(window.MINDAR && window.MINDAR.IMAGE)) {
          throw new Error('MindAR script failed to load (window.MINDAR.IMAGE not found)');
        }
      };

      const container = document.querySelector("#container");
      const overlay = document.querySelector('#start-overlay');
      const startBtn = document.querySelector('#start-ar');
      const errorMsg = document.querySelector('#error-msg');

      // Helper to show errors to user
      const showError = (msg) => {
        if (errorMsg) {
          errorMsg.textContent = msg;
          errorMsg.style.display = 'block';
        }
        console.error(msg);
      };

      // Secure context check (camera requires https or localhost)
      if (!window.isSecureContext) {
        showError('This page must be served over HTTPS (or localhost) for camera access.');
      }

      let mindarThree, renderer, scene, camera, anchor;
      let stack, single;

      let loader;
      const getLoader = () => {
        if (!loader) {
          if (!window.THREE || !THREE.GLTFLoader) {
            throw new Error('THREE.GLTFLoader not available yet');
          }
          loader = new THREE.GLTFLoader();
        }
        return loader;
      };

      const setupScene = () => {
        const hemi = new THREE.HemisphereLight(0xffffff, 0x444466, 1.0);
        scene.add(hemi);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(0.5, 1.0, 0.5);
        scene.add(dir);
      };

      const makeAnchor = () => {
        anchor = mindarThree.addAnchor(0);
        anchor.onTargetFound = () => { if (stack) stack.visible = true; if (single) single.visible = true; };
        anchor.onTargetLost  = () => { if (stack) stack.visible = false; if (single) single.visible = false; };
      };

      const loadStack = () => new Promise((resolve, reject) => {
        getLoader().load("/pulp-ar/assets/test_stack.glb", (gltf) => {
          stack = gltf.scene;
          stack.scale.set(0.18, 0.18, 0.18);
          stack.position.set(0, 0, 0.002); // offset to avoid z-fighting
          anchor.group.add(stack);
          resolve();
        }, undefined, (err) => reject(err));
      });

      const loadSingle = () => new Promise((resolve, reject) => {
        getLoader().load("/pulp-ar/assets/test_single.glb", (gltf) => {
          single = gltf.scene;
          single.scale.set(0.16, 0.16, 0.16);
          single.position.set(0, 0, 0.08);
          single.rotation.set(THREE.Math.degToRad(-10), 0, THREE.Math.degToRad(8));
          anchor.group.add(single);
          resolve();
        }, undefined, (err) => reject(err));
      });

      const preflightCamera = async () => {
        // Ensure mediaDevices.getUserMedia exists (polyfill for older iOS)
        if (typeof navigator.mediaDevices === 'undefined') {
          navigator.mediaDevices = {};
        }
        if (typeof navigator.mediaDevices.getUserMedia !== 'function') {
          const getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
          if (!getUserMedia) {
            throw new Error('getUserMedia is not supported on this browser.');
          }
          navigator.mediaDevices.getUserMedia = (constraints) => new Promise((resolve, reject) => {
            getUserMedia.call(navigator, constraints, resolve, reject);
          });
        }

        // Request camera access explicitly on user gesture
        const constraints = { video: { facingMode: { ideal: 'environment' } }, audio: false };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);

        // Immediately release the camera so MindAR can take over
        if (stream && stream.getTracks) {
          stream.getTracks().forEach((t) => t.stop());
        }
      };

      const verifyMindFile = async (path) => {
        try {
          const res = await fetch(path, { method: 'HEAD', cache: 'no-store' });
          if (!res.ok) throw new Error(`.mind fetch failed with status ${res.status}`);
        } catch (err) {
          throw new Error(`Mind file not reachable at ${path}: ${err.message}`);
        }
      };

      const startAR = async () => {
        // Hide any old error
        if (errorMsg) { errorMsg.textContent = ''; errorMsg.style.display = 'none'; }

        // 1) Permission preflight
        try {
          await preflightCamera();
        } catch (e) {
          let hint = 'Camera permission was not granted.';
          if (e && (e.name === 'NotAllowedError' || e.name === 'SecurityError')) {
            hint = 'Camera access was blocked. On iOS: Settings → Safari → Camera → Allow. In Safari (aA) → Website Settings → Camera → Allow. Then reload and tap Start AR again.';
          }
          showError(hint);
          return;
        }

        // 2) Verify marker file exists (avoid mislabeling as camera issue)
        const mindPath = '/pulp-ar/assets/pulp-marker.mind';
        try {
          await verifyMindFile(mindPath);
        } catch (e) {
          console.error('Mind file check failed:', e);
          showError(`Marker file not found: ${mindPath}. Make sure it is deployed at that path.`);
          return;
        }

        // Ensure MindAR script is loaded and ready
        await ensureMindAR();

        // Ensure THREE has loaded (from deferred script)
        let retries = 0;
        while (!window.THREE && retries < 50) {
          await new Promise((r) => setTimeout(r, 100));
          retries++;
        }
        if (!window.THREE) {
          throw new Error('THREE not loaded. Check script order or network.');
        }
        
        // Ensure GLTFLoader is available
        if (!window.THREE.GLTFLoader) {
          throw new Error('THREE.GLTFLoader not available');
        }

        // 3) Boot MindAR
        try {
          mindarThree = new window.MINDAR.IMAGE.MindARThree({
            container,
            imageTargetSrc: mindPath,
            filterMinCF: 0.0001,
            filterBeta: 0.01
          });
          ({ renderer, scene, camera } = mindarThree);

          setupScene();
          makeAnchor();

          await mindarThree.start();
        } catch (e) {
          console.error('MindAR start error:', e);
          let hint = 'MindAR could not start the camera.';
          if (e && e.message) {
            hint += `\n${e.message}`;
            // iOS-specific guidance
            if (/ios|iphone|ipad/i.test(navigator.userAgent)) {
              hint += '\n\nFor iOS: Ensure you granted camera permission and reload the page if needed.';
            }
          }
          showError(hint);
          return;
        }

        // 4) Load models
        try {
          await loadStack();
          await loadSingle();
        } catch (e) {
          console.error('Model load error:', e);
          showError('Models failed to load. Check the GLB paths under /pulp-ar/assets/.');
          return;
        }

        // 5) Start render loop
        const clock = new THREE.Clock();
        renderer.setAnimationLoop(() => {
          const t = clock.getElapsedTime();
          if (single) {
            single.rotation.z += 0.02;
            single.position.z = 0.08 + 0.005 * Math.sin(t * 2.0);
          }
          renderer.render(scene, camera);
        });

        if (overlay) overlay.style.display = 'none';
      };

      // Some browsers (esp. iOS Safari) require a user gesture to start camera
      if (startBtn) {
        startBtn.addEventListener('click', async () => {
          startBtn.textContent = 'Starting...';
          try {
            await startAR();
          } catch (e) {
            showError('Failed to start AR: ' + (e.message || e));
            startBtn.textContent = 'Start AR';
          }
        }, { once: true });
      } else {
        // Fallback: try to auto-start if button missing
        startAR();
      }
    })();
  </script>
</body>
</html>